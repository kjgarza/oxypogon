export default function(eleventyConfig) {
  // Passthrough copy for static assets
  eleventyConfig.addPassthroughCopy("src/js");
  eleventyConfig.addPassthroughCopy("src/css");
  eleventyConfig.addPassthroughCopy("src/assets");
  eleventyConfig.addPassthroughCopy({ "favicon.png": "favicon.png" });
  
  // Disable Jekyll processing on GitHub Pages
  eleventyConfig.addPassthroughCopy({ ".nojekyll": ".nojekyll" });

  // CRITICAL: Copy outputs directory for WOD data (generated by Deno pipeline)
  eleventyConfig.addPassthroughCopy("outputs");

  // Custom filter: serialize to JSON
  eleventyConfig.addFilter("json", value => JSON.stringify(value));

  // Custom filter: format date
  eleventyConfig.addFilter("formatDate", function(dateString) {
    if (!dateString) return "";
    return new Date(dateString).toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  });

  // Custom filter: format timestamp
  eleventyConfig.addFilter("formatTimestamp", function(dateString) {
    if (!dateString) return "";
    return new Date(dateString).toLocaleString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  });

  // Custom filter: group movements by category
  eleventyConfig.addFilter("groupByCategory", function(movements) {
    if (!movements || !Array.isArray(movements)) return {};
    return movements.reduce((acc, movement) => {
      const category = movement.category || "Uncategorized";
      if (!acc[category]) {
        acc[category] = [];
      }
      acc[category].push(movement);
      return acc;
    }, {});
  });

  // Custom filter: get unique branches from heroes
  eleventyConfig.addFilter("uniqueBranches", function(heroes) {
    if (!heroes || !Array.isArray(heroes)) return [];
    const branches = new Set();
    heroes.forEach(hero => {
      if (hero.honoree?.branch) {
        branches.add(hero.honoree.branch);
      }
    });
    return Array.from(branches).sort();
  });

  // Custom filter: replace underscores with spaces and title case
  eleventyConfig.addFilter("titleCase", function(str) {
    if (!str) return "";
    return str
      .replace(/_/g, " ")
      .replace(/\b\w/g, char => char.toUpperCase());
  });

  // Custom filter: convert YouTube watch URL to embed URL
  eleventyConfig.addFilter("youtubeEmbed", function(url) {
    if (!url) return null;
    const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
    return match ? `https://www.youtube.com/embed/${match[1]}` : null;
  });

  return {
    pathPrefix: "/oxypogon/",
    dir: {
      input: "src",
      output: "_site",
      includes: "_includes",
      data: "_data"
    },
    templateFormats: ["njk", "md", "html"],
    htmlTemplateEngine: "njk",
    markdownTemplateEngine: "njk"
  };
}
